<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾‹å¸« AI æ¡ˆæƒ…åˆ†æå®¤</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a2a6c">
    <link rel="apple-touch-icon" href="icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root { --legal-blue: #1a2a6c; --bg: #f5f7fa; --success: #27ae60; --text-gray: #666; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; box-sizing: border-box; -webkit-user-select: none; user-select: none; padding-bottom: 50px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        .header { text-align: center; color: var(--legal-blue); margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .header p { margin: 5px 0 0; font-size: 0.9rem; color: var(--text-gray); }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; transition: 0.3s; }
        
        /* è¼¸å…¥å€èˆ‡ç·¨è¼¯å€ */
        textarea { 
            width: 100%; min-height: 120px; border: 1px solid #ddd; border-radius: 8px; padding: 12px; 
            font-size: 1rem; line-height: 1.6; box-sizing: border-box; resize: vertical; font-family: inherit;
            -webkit-user-select: text; user-select: text;
        }
        textarea:focus { outline: none; border-color: var(--legal-blue); }
        
        /* æª”æ¡ˆä¸Šå‚³å€æ¨£å¼ */
        .file-upload-wrapper {
            margin-top: 15px;
            border: 2px dashed #ddd;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            position: relative;
        }
        .file-upload-wrapper:hover { border-color: var(--legal-blue); }
        input[type="file"] { width: 100%; margin-top: 5px; }

        /* çµæœç·¨è¼¯å€ç‰¹åˆ¥æ¨£å¼ */
        #result-editor { 
            min-height: 350px; border-color: #dcdcdc; background-color: #fafafa; 
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { background: var(--legal-blue); color: white; border: none; width: 100%; padding: 15px; border-radius: 30px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.98); }
        .btn-save { background: var(--success); margin-top: 15px; }
        .btn-reset { background: #95a5a6; margin-top: 10px; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading { display: none; text-align: center; margin: 20px 0; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--legal-blue); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* éš±è—å€å¡Šæ§åˆ¶ */
        .hidden { display: none; }
        
        label { font-weight: bold; color: var(--legal-blue); display: block; margin-bottom: 8px; font-size: 0.95rem; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; -webkit-user-select: text; user-select: text; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>âš–ï¸ æ¡ˆæƒ…åˆ†æå®¤</h1>
            <p>AI è¼”åŠ©æ³•å¾‹è¨ºæ–·èˆ‡æ­¸æª”ç³»çµ±</p>
        </div>

        <div class="card" id="input-section">
            <label>1. ç•¶äº‹äººé™³è¿° / æ¡ˆæƒ…æ‘˜è¦</label>
            <textarea id="case-detail" placeholder="è«‹è¼¸å…¥äº‹å¯¦ç¶“éï¼Œä¾‹å¦‚ï¼šè»Šç¦ç™¼ç”Ÿæ™‚é–“ã€åœ°é»ã€æå®³ç‹€æ³ï¼Œæˆ–å‚µå‹™ç³¾ç´›ä¹‹ç´„å®šèˆ‡é•ç´„æƒ…å½¢..."></textarea>
            
            <label style="margin-top: 15px;">2. ä¸Šå‚³ä½è­‰è³‡æ–™ (é¸å¡«)</label>
            <div class="file-upload-wrapper">
                <input type="file" id="case-file" accept="image/*,application/pdf,.doc,.docx,.txt">
                <small style="display:block; color:#999; margin-top:5px;">æ”¯æ´åœ–ç‰‡ã€PDFã€Word (å»ºè­° < 10MB)</small>
            </div>

            <button class="btn" style="margin-top: 15px;" onclick="startAnalysis()">
                <span>ğŸ” é–‹å§‹æ™ºæ…§åˆ†æ</span>
            </button>
        </div>

        <div class="loading" id="loading-spinner">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">AI åŠ©ç†æ­£åœ¨ç ”è®€æ¡ˆæƒ…èˆ‡æª”æ¡ˆ...</p>
        </div>

        <div class="card hidden" id="result-section">
            <label>ğŸ“‹ åˆ†æå ±å‘Š (å¯é»æ“Šä¿®æ”¹)</label>
            <textarea id="result-editor"></textarea>
            
            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">
            
            <label>æ­¸æª”è¨­å®š (å­˜è‡³ Google Drive)</label>
            <input type="text" id="doc-filename" placeholder="è«‹è¼¸å…¥æª”æ¡ˆåç¨±">
            
            <button class="btn btn-save" id="btn-save-cloud" onclick="saveToDrive()">
                <span>â˜ï¸ ç¢ºèªå„²å­˜</span>
            </button>
            <button class="btn btn-reset" onclick="location.reload()">
                <span>ğŸ”„ æ¸…é™¤é‡ä¾†</span>
            </button>
        </div>
    </div>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker è¨»å†ŠæˆåŠŸ'))
            .catch(err => console.log('Service Worker è¨»å†Šå¤±æ•—:', err));
        });
      }
    </script>

    <script>
        // ==========================================
        // âš ï¸ è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ n8n Webhook ç¶²å€
        // ==========================================
        
        // 1. AI åˆ†æç”¨çš„ Webhook (æ¥æ”¶ description + file -> å›å‚³ analysis)
        const WEBHOOK_ANALYSIS = 'https://l52511.zeabur.app/webhook/case-analysis'; 
        
        // 2. Google Drive å­˜æª”ç”¨çš„ Webhook (æ¥æ”¶ filename, content -> å­˜æª”)
        const WEBHOOK_SAVE = 'https://l52511.zeabur.app/webhook/save-to-docs';

        // ==========================================

        async function startAnalysis() {
            const content = document.getElementById('case-detail').value;
            const fileInput = document.getElementById('case-file');
            
            if (!content && fileInput.files.length === 0) {
                return alert("è«‹è‡³å°‘è¼¸å…¥æ¡ˆæƒ…æè¿°æˆ–ä¸Šå‚³æª”æ¡ˆ");
            }

            // åˆ‡æ›ç•«é¢
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('loading-spinner').style.display = 'block';

            try {
                // æ”¹ç”¨ FormData ä¾†æ‰“åŒ…è³‡æ–™ (æ”¯æ´æ–‡å­—+æª”æ¡ˆ)
                const formData = new FormData();
                formData.append('description', content);
                
                if (fileInput.files.length > 0) {
                    // å¦‚æœæœ‰æª”æ¡ˆï¼ŒæŠŠå®ƒåŠ é€²å»ï¼Œæ¬„ä½åç¨±å« 'file'
                    formData.append('file', fileInput.files[0]);
                }

                const response = await fetch(WEBHOOK_ANALYSIS, {
                    method: 'POST',
                    // æ³¨æ„ï¼šç•¶ä½¿ç”¨ FormData æ™‚ï¼Œä¸éœ€è¦æ‰‹å‹•è¨­å®š 'Content-Type'
                    body: formData
                });
                
                if (!response.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");

                const data = await response.json();
                
                const aiResponse = data.analysis || data.output || "åˆ†æå®Œæˆï¼Œä½†ç„¡æ³•å–å¾—å…§å®¹ã€‚";

                document.getElementById('result-editor').value = aiResponse;
                
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                document.getElementById('doc-filename').value = `æ¡ˆæƒ…åˆ†æ_${dateStr}`;

                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('result-section').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                alert("é€£ç·šå¤±æ•—ï¼šè«‹æª¢æŸ¥ n8n Webhook æ˜¯å¦é–‹å•Ÿï¼Œæˆ–ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚");
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('input-section').classList.remove('hidden');
            }
        }

        async function saveToDrive() {
            const finalContent = document.getElementById('result-editor').value;
            const filename = document.getElementById('doc-filename').value;
            const btn = document.getElementById('btn-save-cloud');

            if (!filename) return alert("è«‹è¼¸å…¥æª”æ¡ˆåç¨±");

            const originalText = btn.innerHTML;
            btn.innerHTML = "â³ é›²ç«¯å­˜æª”ä¸­...";
            btn.disabled = true;

            try {
                // å­˜æª”éƒ¨åˆ†ç¶­æŒ JSON æ ¼å¼ï¼Œå› ç‚ºåªéœ€è¦å­˜æ–‡å­—
                const response = await fetch(WEBHOOK_SAVE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        content: finalContent,
                        filename: filename
                    })
                });
                
                if (response.ok) {
                    alert("âœ… æˆåŠŸï¼æ–‡ä»¶å·²å­˜å…¥æ‚¨çš„ Google Drive");
                } else {
                    alert("âŒ å­˜æª”å¤±æ•—ï¼Œè«‹æª¢æŸ¥ n8n Google Drive è¨­å®š");
                }

            } catch (error) {
                console.error(error);
                alert("é€£ç·šéŒ¯èª¤");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>