<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾‹å¸« AI æ¡ˆæƒ…åˆ†æå®¤</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a2a6c">
    <link rel="apple-touch-icon" href="icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root { --legal-blue: #1a2a6c; --bg: #f5f7fa; --success: #27ae60; --danger: #e74c3c; --text-gray: #666; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; box-sizing: border-box; -webkit-user-select: none; user-select: none; padding-bottom: 50px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        .header { text-align: center; color: var(--legal-blue); margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .header p { margin: 5px 0 0; font-size: 0.9rem; color: var(--text-gray); }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; transition: 0.3s; }
        
        textarea { 
            width: 100%; min-height: 120px; border: 1px solid #ddd; border-radius: 8px; padding: 12px; 
            font-size: 1rem; line-height: 1.6; box-sizing: border-box; resize: vertical; font-family: inherit;
            -webkit-user-select: text; user-select: text;
        }
        textarea:focus { outline: none; border-color: var(--legal-blue); }
        
        /* --- æª”æ¡ˆä¸Šå‚³å€å„ªåŒ– --- */
        .file-upload-wrapper {
            margin-top: 10px;
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            background: #fafafa;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        .file-upload-wrapper:hover { border-color: var(--legal-blue); background: #f0f4f8; }
        
        /* éš±è—åŸæœ¬çš„ input */
        input[type="file"] { display: none; }
        
        .upload-placeholder { color: #999; pointer-events: none; }
        .upload-icon { font-size: 2rem; display: block; margin-bottom: 5px; }

        /* --- æª”æ¡ˆé è¦½å¡ç‰‡ --- */
        #preview-container {
            display: none; /* é è¨­éš±è—ï¼Œæœ‰æª”æ¡ˆæ‰é¡¯ç¤º */
            margin-top: 15px;
        }
        .file-card {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .file-thumbnail {
            width: 40px; height: 40px;
            background: #eee;
            border-radius: 6px;
            margin-right: 12px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            font-size: 1.2rem;
            color: #666;
            flex-shrink: 0;
        }
        .file-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        
        .file-info { flex-grow: 1; overflow: hidden; }
        .file-name { font-size: 0.9rem; font-weight: bold; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-size { font-size: 0.75rem; color: #999; }

        /* åˆªé™¤æŒ‰éˆ• (X) */
        .btn-remove-file {
            width: 24px; height: 24px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-left: 10px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.4);
        }
        .btn-remove-file:active { transform: scale(0.9); }

        /* çµæœç·¨è¼¯å€ */
        #result-editor { min-height: 350px; border-color: #dcdcdc; background-color: #fafafa; }

        .btn { background: var(--legal-blue); color: white; border: none; width: 100%; padding: 15px; border-radius: 30px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.98); }
        .btn-save { background: var(--success); margin-top: 15px; }
        .btn-reset { background: #95a5a6; margin-top: 10px; }
        
        .loading { display: none; text-align: center; margin: 20px 0; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--legal-blue); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        
        label { font-weight: bold; color: var(--legal-blue); display: block; margin-bottom: 8px; font-size: 0.95rem; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; -webkit-user-select: text; user-select: text; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>âš–ï¸ æ¡ˆæƒ…åˆ†æå®¤</h1>
            <p>AI è¼”åŠ©æ³•å¾‹è¨ºæ–·èˆ‡æ­¸æª”ç³»çµ±</p>
        </div>

        <div class="card" id="input-section">
            <label>1. ç•¶äº‹äººé™³è¿° / æ¡ˆæƒ…æ‘˜è¦</label>
            <textarea id="case-detail" placeholder="è«‹è¼¸å…¥äº‹å¯¦ç¶“éï¼Œä¾‹å¦‚ï¼šè»Šç¦ç™¼ç”Ÿæ™‚é–“ã€åœ°é»ã€æå®³ç‹€æ³ï¼Œæˆ–å‚µå‹™ç³¾ç´›ä¹‹ç´„å®šèˆ‡é•ç´„æƒ…å½¢..."></textarea>
            
            <label style="margin-top: 20px;">2. ä¸Šå‚³ä½è­‰è³‡æ–™ (é¸å¡«)</label>
            
            <div class="file-upload-wrapper" onclick="document.getElementById('case-file').click()">
                <div class="upload-placeholder" id="upload-prompt">
                    <span class="upload-icon">ğŸ“‚</span>
                    <span>é»æ“Šæ­¤è™•ä¸Šå‚³åœ–ç‰‡æˆ–æ–‡ä»¶</span>
                    <br>
                    <small>(æ”¯æ´ PDF, Word, JPG, PNG)</small>
                </div>
                <input type="file" id="case-file" accept="image/*,application/pdf,.doc,.docx,.txt" onchange="handleFileSelect(this)">
            </div>

            <div id="preview-container">
                </div>

            <button class="btn" style="margin-top: 20px;" onclick="startAnalysis()">
                <span>ğŸ” é–‹å§‹æ™ºæ…§åˆ†æ</span>
            </button>
        </div>

        <div class="loading" id="loading-spinner">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">AI åŠ©ç†æ­£åœ¨ç ”è®€æ¡ˆæƒ…èˆ‡æª”æ¡ˆ...</p>
        </div>

        <div class="card hidden" id="result-section">
            <label>ğŸ“‹ åˆ†æå ±å‘Š (å¯é»æ“Šä¿®æ”¹)</label>
            <textarea id="result-editor"></textarea>
            
            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 20px 0;">
            
            <label>æ­¸æª”è¨­å®š (å­˜è‡³ Google Drive)</label>
            <input type="text" id="doc-filename" placeholder="è«‹è¼¸å…¥æª”æ¡ˆåç¨±">
            
            <button class="btn btn-save" id="btn-save-cloud" onclick="saveToDrive()">
                <span>â˜ï¸ ç¢ºèªå„²å­˜</span>
            </button>
            <button class="btn btn-reset" onclick="location.reload()">
                <span>ğŸ”„ æ¸…é™¤é‡ä¾†</span>
            </button>
        </div>
    </div>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker è¨»å†ŠæˆåŠŸ'))
            .catch(err => console.log('Service Worker è¨»å†Šå¤±æ•—:', err));
        });
      }
    </script>

    <script>
        // ==========================================
        // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ n8n Webhook
        // ==========================================
        const WEBHOOK_ANALYSIS = 'https://l52511.zeabur.app/webhook/case-analysis'; 
        const WEBHOOK_SAVE = 'https://l52511.zeabur.app/webhook/save-to-docs';
        // ==========================================

        let currentFile = null; // ç”¨ä¾†æš«å­˜ç›®å‰çš„æª”æ¡ˆç‰©ä»¶

        function handleFileSelect(input) {
            const container = document.getElementById('preview-container');
            const prompt = document.getElementById('upload-prompt');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                currentFile = file; // å­˜å…¥è®Šæ•¸

                // éš±è—æç¤ºæ–‡å­—ï¼Œé¡¯ç¤ºé è¦½å€
                prompt.style.display = 'none';
                container.style.display = 'block';
                container.innerHTML = ''; // æ¸…ç©ºèˆŠçš„

                // åˆ¤æ–·æ˜¯å¦ç‚ºåœ–ç‰‡ï¼Œè‹¥æ˜¯åœ–ç‰‡é¡¯ç¤ºç¸®åœ–ï¼Œå¦å‰‡é¡¯ç¤ºåœ–ç¤º
                let thumbnailHtml = 'ğŸ“„'; // é è¨­æ–‡ä»¶åœ–ç¤º
                if (file.type.startsWith('image/')) {
                    const imgUrl = URL.createObjectURL(file);
                    thumbnailHtml = `<img src="${imgUrl}" alt="preview">`;
                }

                // ç”¢ç”Ÿé è¦½å¡ç‰‡ HTML
                const card = document.createElement('div');
                card.className = 'file-card';
                card.innerHTML = `
                    <div class="file-thumbnail">${thumbnailHtml}</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${(file.size / 1024).toFixed(1)} KB</div>
                    </div>
                    <div class="btn-remove-file" onclick="removeFile()">âœ•</div>
                `;
                container.appendChild(card);
            }
        }

        function removeFile() {
            // 1. æ¸…ç©º input
            const input = document.getElementById('case-file');
            input.value = ''; 
            
            // 2. æ¸…ç©ºæš«å­˜è®Šæ•¸
            currentFile = null;

            // 3. æ¢å¾© UI ç‹€æ…‹
            document.getElementById('preview-container').style.display = 'none';
            document.getElementById('preview-container').innerHTML = '';
            document.getElementById('upload-prompt').style.display = 'block'; // é¡¯ç¤ºåŸæœ¬çš„ã€Œé»æ“Šä¸Šå‚³ã€
        }

        async function startAnalysis() {
            const content = document.getElementById('case-detail').value;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è¼¸å…¥æ–‡å­—æˆ–æœ‰æª”æ¡ˆ
            if (!content && !currentFile) {
                return alert("è«‹è‡³å°‘è¼¸å…¥æ¡ˆæƒ…æè¿°æˆ–ä¸Šå‚³æª”æ¡ˆ");
            }

            // åˆ‡æ›ç•«é¢
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('loading-spinner').style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('description', content);
                
                // ä½¿ç”¨æš«å­˜çš„ currentFile
                if (currentFile) {
                    formData.append('file', currentFile);
                }

                const response = await fetch(WEBHOOK_ANALYSIS, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error("API å›æ‡‰éŒ¯èª¤");

                const data = await response.json();
                const aiResponse = data.analysis || data.output || "åˆ†æå®Œæˆï¼Œä½†ç„¡æ³•å–å¾—å…§å®¹ã€‚";

                document.getElementById('result-editor').value = aiResponse;
                
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                document.getElementById('doc-filename').value = `æ¡ˆæƒ…åˆ†æ_${dateStr}`;

                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('result-section').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                alert("é€£ç·šå¤±æ•—ï¼šè«‹æª¢æŸ¥ n8n Webhook æ˜¯å¦é–‹å•Ÿï¼Œæˆ–ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚");
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('input-section').classList.remove('hidden');
            }
        }

        async function saveToDrive() {
            const finalContent = document.getElementById('result-editor').value;
            const filename = document.getElementById('doc-filename').value;
            const btn = document.getElementById('btn-save-cloud');

            if (!filename) return alert("è«‹è¼¸å…¥æª”æ¡ˆåç¨±");

            const originalText = btn.innerHTML;
            btn.innerHTML = "â³ é›²ç«¯å­˜æª”ä¸­...";
            btn.disabled = true;

            try {
                const response = await fetch('https://your-n8n.zeabur.app/webhook/case-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ description: content })
            });
                
                if (response.ok) {
                    alert("âœ… æˆåŠŸï¼æ–‡ä»¶å·²å­˜å…¥æ‚¨çš„ Google Drive");
                } else {
                    alert("âŒ å­˜æª”å¤±æ•—ï¼Œè«‹æª¢æŸ¥ n8n Google Drive è¨­å®š");
                }

            } catch (error) {
                console.error(error);
                alert("é€£ç·šéŒ¯èª¤");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
